# .github/workflows/deploy-and-run.yml

name: Deploy and Run YouTube Shorts Automation

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ í—ˆìš©í•©ë‹ˆë‹¤.
  schedule:
    - cron: '0 0 * * *' # UTC ê¸°ì¤€ìœ¼ë¡œ ë§¤ì¼ ìì • 00:00ì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ)

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_BUCKET_NAME: ${{ secrets.GCP_BUCKET_NAME }}
  FUNCTION_NAME: youtube-shorts-automation-function
  REGION: us-central1 # Cloud Functions ë°°í¬ ë¦¬ì „
  
  # API í‚¤ë¥¼ GitHub Secretsì—ì„œ ì§ì ‘ ì „ë‹¬ (Cloud Functions ë‚´ë¶€ì—ì„œëŠ” Secret Manager ì‚¬ìš©)
  ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
  ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
  PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
  OPENAI_KEYS_JSON: ${{ secrets.OPENAI_KEYS_JSON }} # JSON ë¬¸ìì—´ í˜•íƒœë¡œ ì „ë‹¬
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
  YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
  YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}

jobs:
  deploy_and_run:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # OIDC í† í°ì„ ë°œí–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Cloud Functions ëŸ°íƒ€ì„ ë²„ì „ê³¼ ì¼ì¹˜ì‹œí‚¤ì„¸ìš”.

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create fonts directory
        run: mkdir -p fonts

      - name: Authenticate to GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          # ğŸš¨ğŸš¨ğŸš¨ ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•©ë‹ˆë‹¤! credentials_json ëŒ€ì‹  workload_identity_providerë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providersgithub-provider-v1'
          service_account: 'github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com' # ìœ„ì—ì„œ ìƒì„±í•œ ì„œë¹„ìŠ¤ ê³„ì • ì´ë©”ì¼
          # ë‚˜ë¨¸ì§€ ì„¤ì •ì€ í•„ìš”ì— ë”°ë¼ ìœ ì§€í•˜ê±°ë‚˜ ì œê±°í•©ë‹ˆë‹¤.
          # create_credentials_file: true
          # export_environment_variables: true
          # universe: googleapis.com
          # cleanup_credentials: true
          # access_token_lifetime: 3600s
          # access_token_scopes: https://www.googleapis.com/auth/cloud-platform
          # id_token_include_email: false

      - name: Deploy Cloud Function (Optional: Deploy only when code changes)
        id: deploy
        uses: 'google-github-actions/deploy-cloudfunctions@v2'
        with:
          name: ${{ env.FUNCTION_NAME }}
          runtime: python311 # Python ëŸ°íƒ€ì„ ë²„ì „
          entry_point: youtube_automation_main # main.pyì— ì •ì˜ëœ í•¨ìˆ˜ ì´ë¦„
          source: src # Cloud Function ì½”ë“œê°€ ìˆëŠ” ë””ë ‰í† ë¦¬
          region: ${{ env.REGION }}
          memory: 1024MB # í•¨ìˆ˜ ë©”ëª¨ë¦¬ ì„¤ì • (í•„ìš”ì— ë”°ë¼ ì¡°ì •)
          timeout: 540s # í•¨ìˆ˜ íƒ€ì„ì•„ì›ƒ (ìµœëŒ€ 540ì´ˆ = 9ë¶„)
          # í™˜ê²½ ë³€ìˆ˜ë¥¼ Cloud Functionìœ¼ë¡œ ì „ë‹¬
          env_vars: |
            GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
            GCP_BUCKET_NAME=${{ env.GCP_BUCKET_NAME }}
            ELEVENLABS_API_KEY=${{ env.ELEVENLABS_API_KEY }}
            ELEVENLABS_VOICE_ID=${{ env.ELEVENLABS_VOICE_ID }}
            NEWS_API_KEY=${{ env.NEWS_API_KEY }}
            PEXELS_API_KEY=${{ env.PEXELS_API_KEY }}
            OPENAI_KEYS_JSON=${{ env.OPENAI_KEYS_JSON }}
            GEMINI_API_KEY=${{ env.GEMINI_API_KEY }}
            YOUTUBE_CLIENT_ID=${{ env.YOUTUBE_CLIENT_ID }}
            YOUTUBE_CLIENT_SECRET=${{ env.YOUTUBE_CLIENT_SECRET }}
            YOUTUBE_REFRESH_TOKEN=${{ env.YOUTUBE_REFRESH_TOKEN }}
          # Cloud Functionsì—ì„œ Secret Managerì— ì ‘ê·¼í•  ê¶Œí•œì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì • ì§€ì •
          service_account_email: 'github-actions-user@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com' # Cloud Functionì´ ì‚¬ìš©í•  ì„œë¹„ìŠ¤ ê³„ì •
        # Cloud Functionì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆì„ ë•Œë§Œ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
        if: success() || github.event_name == 'workflow_dispatch' # ìˆ˜ë™ ì‹¤í–‰ ì‹œ í•­ìƒ ë°°í¬

      - name: Invoke Cloud Function
        id: invoke
        uses: 'google-github-actions/cloudfunctions-invoke@v2'
        with:
          name: ${{ env.FUNCTION_NAME }}
          region: ${{ env.REGION }}
          data: '{"daily_run": true}' # Cloud Functionì— ì „ë‹¬í•  ë°ì´í„°
        if: always() # ë°°í¬ê°€ ì‹¤íŒ¨í•´ë„ í˜¸ì¶œ ì‹œë„ (ë””ë²„ê¹… ëª©ì )

      - name: Monitor Cloud Function Logs
        run: |
          gcloud functions logs read ${{ env.FUNCTION_NAME }} --region=${{ env.REGION }} --limit=50 --format=json
        if: always() # í•­ìƒ ë¡œê·¸ë¥¼ í™•ì¸í•˜ë„ë¡ ì„¤ì • (ë””ë²„ê¹…ì— ìœ ìš©)
