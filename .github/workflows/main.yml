name: GCP YouTube Automation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_NAME: gcp-youtube-automation
  REGION: us-central1
  PROJECT_ID: youtube-fully-automated
  WORKLOAD_IDENTITY_PROVIDER: "projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1"
  SERVICE_ACCOUNT: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  setup:  # setup-auth ëŒ€ì‹  setupìœ¼ë¡œ í†µí•©
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Google Cloud ì¸ì¦
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}
        access_token_lifetime: 3600s
        # audienceëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev

  deploy:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Google Cloud ì¸ì¦
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.13'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ì¸ë„¤ì¼ ìë™ ìƒì„±
      run: python3 src/thumbnail_generator.py

    - name: ëŒ“ê¸€ ìë™í™”
      run: python3 src/comment_poster.py

    # ì—¬ê¸°ì„œëŠ” ì‹œí¬ë¦¿ì„ ë¡œë“œí•˜ì§€ ì•ŠìŒ. generate-contentì—ì„œ ë¡œë“œ

  generate-content:
    runs-on: ubuntu-latest
    needs: [setup]  # deployëŠ” í•„ìš”ì—†ìŒ
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Google Cloud ì¸ì¦
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Secret Managerì—ì„œ ì‹œí¬ë¦¿ ë¡œë“œ
      id: load-secrets
      run: |
        echo "ğŸ” ì‹œí¬ë¦¿ ë¡œë“œ ì‹œì‘"
        
        declare -A secret_map=(
          ["OPENAI_API_KEY"]="openai-api-keys"
          ["GEMINI_API_KEY"]="gemini-api-key"
          ["ELEVENLABS_API_KEY"]="elevenlabs-api-key"
          ["YOUTUBE_CREDENTIALS"]="youtube-oauth-credentials"
          ["STORAGE_BUCKET"]="storage-bucket-name"
          ["PEXELS_API_KEY"]="PEXELS_API_KEY"
        )
        
        for env_var in "${!secret_map[@]}"; do
          secret_name=${secret_map[$env_var]}
          echo "[ì‹œí¬ë¦¿] $env_var ë¡œë“œ: $secret_name"
          
          secret_value=$(gcloud secrets versions access latest \
            --secret=$secret_name \
            --project=$PROJECT_ID \
            --format="value(data)")
            
          # JSON í˜•ì‹ ì‹œí¬ë¦¿ ì²˜ë¦¬
          if [[ $secret_name == *"credentials"* ]]; then
            echo "$env_var<<EOF" >> $GITHUB_ENV
            echo "$secret_value" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "$env_var=$secret_value" >> $GITHUB_ENV
          fi
          echo "âœ… $env_var ì„¤ì • ì™„ë£Œ"
        done

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.13'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ë§¤ì¼ ìˆ˜ìµí™”ë˜ëŠ” ì½˜í…ì¸  ìƒì„±
      env:
        OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
        ELEVENLABS_API_KEY: ${{ env.ELEVENLABS_API_KEY }}
        YOUTUBE_CREDENTIALS: ${{ env.YOUTUBE_CREDENTIALS }}
        STORAGE_BUCKET: ${{ env.STORAGE_BUCKET }}
        PEXELS_API_KEY: ${{ env.PEXELS_API_KEY }}
      run: |
        # ë¬´ë£Œ í•œë„ ë‚´ì—ì„œ ì‹¤í–‰ (í•˜ë£¨ 3ê°œ)
        MAX_VIDEOS=3
        
        # ìˆ˜ìµí™” ê°€ëŠ¥í•œ ì£¼ì œ ë¦¬ìŠ¤íŠ¸
        MONETIZABLE_TOPICS=(
          "ì¸ê³µì§€ëŠ¥ìœ¼ë¡œ ìˆ˜ìµë‚´ëŠ” ë²•"
          "ë¬´ì¸ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•"
          "ì½”ë”© ì—†ì´ AIë¡œ ë§¤ì¼ 50ë§Œì› ë²„ëŠ” ë°©ë²•"
          "ìœ íŠœë¸Œ ìë™í™”ë¡œ ì›” 1ì–µ ë§Œë“¤ê¸°"
          "êµ¬ê¸€ í´ë¼ìš°ë“œ ë¬´ë£Œ í™œìš©ë²•"
        )
        
        VIDEO_COUNT=0
        
        for topic in "${MONETIZABLE_TOPICS[@]}"; do
          if [ $VIDEO_COUNT -ge $MAX_VIDEOS ]; then
            echo "ğŸš€ ì˜¤ëŠ˜ ìµœëŒ€ ë¬´ë£Œ í•œë„ ì™„ë£Œ! ì´ $VIDEO_COUNTê°œ ì˜ìƒ ìƒì„±"
            break
          fi
          
          echo "ğŸ¤‘ ìˆ˜ìµí™” ì˜ìƒ ìƒì„±: $topic"
          DURATION=$(( 180 + RANDOM % 300 ))  # 3~8ë¶„
          
          # ì‹¤ì œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python3 src/content_generator.py --topic "$topic"
          python3 src/video_creator.py --topic "$topic" --duration $DURATION
          python3 src/thumbnail_generator.py --topic "$topic"
          python3 src/youtube_uploader.py --topic "$topic"
          
          SLEEP_TIME=$(( 300 + RANDOM % 300 ))  # 5~10ë¶„ ëŒ€ê¸°
          echo "â± ë‹¤ìŒ ì˜ìƒê¹Œì§€ $(($SLEEP_TIME/60))ë¶„ í›„"
          sleep $SLEEP_TIME
          
          ((VIDEO_COUNT++))
        done
        
        echo "âœ… ì˜¤ëŠ˜ ì´ $VIDEO_COUNTê°œ ìˆ˜ìµí™” ì˜ìƒ ìƒì„± ì™„ë£Œ! ì˜ˆìƒ ìˆ˜ìµ: $(($VIDEO_COUNT * 50000))ì›"
