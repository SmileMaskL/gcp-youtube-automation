name: YouTube Automation (수익 창출 봇)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  # schedule:
    # - cron: '0 3,7,12,18,22 * * *'  # 하루 5번 실행 (오전3시,7시,12시,18시,22시)

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          # GCP 환경과 GitHub 환경 분리 설치
          if [ "$CLOUD_SHELL" = "true" ]; then
          pip install -r requirements-gcp.txt
          pip install jedi==0.18.0
          pip install --upgrade python-language-server
          fi
          pip install -r requirements.txt

      - name: Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            ffmpeg \
            imagemagick \
            libfreetype6-dev \
            libjpeg-dev \
            zlib1g-dev \
            fonts-dejavu \
            fonts-noto-cjk \
            libmagic-dev
          
          # ImageMagick 보안 정책 수정
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/g' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/rights="none" pattern="LABEL"/rights="read|write" pattern="LABEL"/g' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/rights="none" pattern="TEXT"/rights="read|write" pattern="TEXT"/g' /etc/ImageMagick-6/policy.xml

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip cache purge
          pip install --upgrade --force-reinstall -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: 'projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1'
          service_account: 'github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com'

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Create necessary directories
        run: |
          mkdir -p temp output
          sudo chmod -R 777 temp output

      - name: Run YouTube Automation Bot
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ELEVENLABS_VOICE_ID: 'uyVNoMrnUku1dZyVEXwD'
        run: |
          # 필수 프로그램 확인
          which ffmpeg
          which convert
          
          # 메인 스크립트 실행 (최대 3회 재시도)
          for i in {1..3}; do
            if python src/main.py; then
              echo "실행 성공!"
              break
            else
              echo "실패! 재시도 중... ($i/3)"
              sleep 5
            fi
          done

      - name: Upload generated videos
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: youtube-shorts
          path: output/
          retention-days: 1
