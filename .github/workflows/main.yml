# .github/workflows/main.yml
name: YouTube Shorts Automation

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3,7,12,18,22 *'

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11' # âš ï¸ ë°˜ë“œì‹œ 3.11 ì‚¬ìš© (ì´ì „ ë‹µë³€ì—ì„œ 3.12ì˜€ëŠ”ë° ë³€ê²½ë˜ì—ˆë„¤ìš”, ì¼ê´€ì„± ìœ ì§€)

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          # ìºì‹œ ì œê±° (ì´ˆê¸°í™” ë‹¨ê³„ì—ì„œ í•œ ë²ˆë§Œ í•„ìš”)
          pip cache purge
          rm -rf ~/.cache/pip
          rm -rf ~/.local/lib/python*/site-packages

          # pip/setuptools/wheel ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ (í•œ ë²ˆë§Œ)
          python -m pip install --upgrade pip setuptools wheel

          # ğŸ¯ google-cloud-secret-manager 2.24.0ì„ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì¹˜ (ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ)
          pip install google-cloud-secret-manager==2.24.0 --no-cache-dir --force-reinstall

          # ë‚˜ë¨¸ì§€ requirements.txtì˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          # (requirements.txtì—ì„œ google-cloud-secret-manager ë¼ì¸ì„ ì‚­ì œí•´ì•¼ í•¨)
          pip install -r requirements.txt --no-cache-dir

          # yt-dlp ì§ì ‘ GitHubì—ì„œ ì„¤ì¹˜ (ì´ì „ ì½”ë“œì—ì„œ yt-dlp Skipping ê²½ê³ ê°€ ìˆì—ˆëŠ”ë°, ì´ ë°©ì‹ì´ ë” ì•ˆì •ì ì…ë‹ˆë‹¤)
          pip install "yt-dlp @ https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.tar.gz"

          # google-auth, google-api-python-clientëŠ” requirements.txtì— ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì„¤ì¹˜ ë¶ˆí•„ìš”
          # ë‹¨, íŠ¹ì • ë²„ì „ ê°•ì œê°€ í•„ìš”í•˜ë‹¤ë©´ requirements.txtì—ì„œ ë²„ì „ ëª…ì‹œ

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Test ADC authentication
        run: |
          gcloud auth list
          gcloud projects list

      - name: Run YouTube Shorts Automation
        run: python -m src.main
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          OPENAI_KEYS_JSON: ${{ secrets.OPENAI_KEYS_JSON }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
          YOUTUBE_OAUTH_CREDENTIALS: ${{ secrets.YOUTUBE_OAUTH_CREDENTIALS }}
          GCP_BUCKET_NAME: ${{ secrets.GCP_BUCKET_NAME }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
