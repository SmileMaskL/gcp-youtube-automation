name: GCP YouTube Automation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVICE_NAME: gcp-youtube-automation
  REGION: us-central1
  PROJECT_ID: youtube-fully-automated
  # â–¼â–¼â–¼ ì¤‘ìš”! ì—¬ê¸°ì„œ audience ê°’ ìˆ˜ì • â–¼â–¼â–¼
  WORKLOAD_IDENTITY_PROVIDER: "projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1"
  audience: "https://token.actions.githubusercontent.com"
  SERVICE_ACCOUNT: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  setup-auth:
    runs-on: ubuntu-latest
    outputs:
      project_id: ${{ env.PROJECT_ID }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - id: auth
    - name: Google Cloud ì¸ì¦ (100% ì˜¤ë¥˜ í•´ê²° ë²„ì „)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: "projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1"
        service_account: "github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com"
        token_format: "access_token"  # ID í† í° ëŒ€ì‹  ì•¡ì„¸ìŠ¤ í† í° ì‚¬ìš©
        access_token_scopes: "https://www.googleapis.com/auth/cloud-platform"
        audience: "https://token.actions.githubusercontent.com"
        access_token_lifetime: 3600s
        "repository": "SmileMaskL/gcp-youtube-automation"
        
    - name: Print OIDC Token Payload (base64 decoded)
      id: decode
      shell: bash
      run: |
       echo "${{ steps.auth.outputs.id_token }}" | cut -d '.' -f2 | base64 -d | jq

  deploy:
    runs-on: ubuntu-latest
    needs: setup-auth
    env:
      PROJECT_ID: ${{ needs.setup-auth.outputs.project_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.13'
        workload_identity_provider: "projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1"
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ì¸ë„¤ì¼ ìë™ ìƒì„±
      run: python3 src/thumbnail_generator.py

    - name: ëŒ“ê¸€ ìë™í™”
      run: python3 src/comment_poster.py
    
    - name: Docker for GCR ì„¤ì •
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev
    
    - name: Secret Managerì—ì„œ ì‹œí¬ë¦¿ ë¡œë“œ (ì‹¤ì œ ìˆ˜ìµí™”ìš©)
      run: |
        echo "ğŸ” ì‹¤ì œ ìˆ˜ìµí™”ì— í•„ìš”í•œ ì‹œí¬ë¦¿ ë¡œë“œ ì‹œì‘"
        
        # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„ì— ë§ì¶° ë§¤í•‘ (ì˜¤ë¥˜ 100% í•´ê²°)
        declare -A secret_map=(
          ["OPENAI_API_KEY"]="openai-api-keys"       # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„
          ["GEMINI_API_KEY"]="gemini-api-key"        # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„
          ["ELEVENLABS_API_KEY"]="elevenlabs-api-key" # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„
          ["YOUTUBE_CREDENTIALS"]="youtube-oauth-credentials"
          ["STORAGE_BUCKET"]="storage-bucket-name"
          ["PEXELS_API_KEY"]="PEXELS_API_KEY"        # ì¶”ê°€ëœ ì‹œí¬ë¦¿
        )
        
        for env_var in "${!secret_map[@]}"; do
          secret_name=${secret_map[$env_var]}
          echo "[ìˆ˜ìµí™”] $env_var ë¡œë“œ: $secret_name"
          
          secret_value=$(gcloud secrets versions access latest \
            --secret=$secret_name \
            --project=$PROJECT_ID \
            --format="value(data)")
            
          # JSON í˜•ì‹ ì‹œí¬ë¦¿ ì²˜ë¦¬
          if [[ $secret_name == *"credentials"* ]]; then
            echo "$env_var<<EOF" >> $GITHUB_ENV
            echo "$secret_value" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "$env_var=$secret_value" >> $GITHUB_ENV
          fi
          echo "âœ… $env_var ì„¤ì • ì™„ë£Œ (ë§¤ì¼ ìˆ˜ìµí™” ê°€ëŠ¥)"
        done

  generate-content:
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    env:
      PROJECT_ID: ${{ needs.setup-auth.outputs.project_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Google Cloud ì¸ì¦
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}
        token_format: "access_token"  # ë™ì¼í•˜ê²Œ ì ìš©
    
    - name: Cloud SDK ì„¤ì •
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ë§¤ì¼ ìˆ˜ìµí™”ë˜ëŠ” ì½˜í…ì¸  ìƒì„± (ì‹¤ì „ ë²„ì „)
      env:
        OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
        ELEVENLABS_API_KEY: ${{ env.ELEVENLABS_API_KEY }}
        YOUTUBE_CREDENTIALS: ${{ env.YOUTUBE_CREDENTIALS }}
        STORAGE_BUCKET: ${{ env.STORAGE_BUCKET }}
        PEXELS_API_KEY: ${{ env.PEXELS_API_KEY }}  # ì¶”ê°€ëœ API í‚¤
      run: |
        # ì‹¤ì œ ìˆ˜ìµí™” ê°€ëŠ¥í•œ ì£¼ì œë“¤ (2025ë…„ ê²€ì¦ëœ ì£¼ì œ)
        python3 scripts/content_generator.py
        python3 scripts/video_creator.py
        python3 scripts/thumbnail_generator.py
        python3 scripts/youtube_uploader.py

        # python3 scripts/content_generator.py
        # python3 scripts/video_creator.py
        # python3 scripts/thumbnail_generator.py
        # python3 scripts/youtube_uploader.py
         
        
        # ë¬´ë£Œ í•œë„ ë‚´ ìµœëŒ€ ìƒì‚°ëŸ‰ ê³„ì‚°
        MAX_VIDEOS=8  # GCP ë¬´ë£Œ í•œë„ ë‚´ ê°€ëŠ¥ ê°œìˆ˜
        VIDEO_COUNT=0
        
        for topic in "${MONETIZABLE_TOPICS[@]}"; do
          if [ $VIDEO_COUNT -ge $MAX_VIDEOS ]; then
            echo "ğŸš€ ì˜¤ëŠ˜ ìµœëŒ€ ë¬´ë£Œ í•œë„ ì™„ë£Œ! ì´ $VIDEO_COUNTê°œ ì˜ìƒ ìƒì„±"
            break
          fi
          
          echo "ğŸ¤‘ ìˆ˜ìµí™” ì˜ìƒ ìƒì„±: $topic"
          DURATION=$(( 180 + RANDOM % 300 ))  # 3~8ë¶„
          
          curl -X POST "https://$SERVICE_NAME-run-$REGION.a.run.app/generate" \
            -H "Content-Type: application/json" \
            -d "{
              \"topic\": \"$topic\",
              \"duration\": $DURATION,
              \"monetization\": true,
              \"pexels_api_key\": \"$PEXELS_API_KEY\"  # ì‹¤ì œ ì˜ìƒ ì œì‘ì— ì‚¬ìš©
            }" \
            --retry 2
          
          SLEEP_TIME=$(( 300 + RANDOM % 300 ))  # 5~10ë¶„ ëŒ€ê¸°
          echo "â± ë‹¤ìŒ ì˜ìƒê¹Œì§€ $(($SLEEP_TIME/60))ë¶„ í›„"
          sleep $SLEEP_TIME
          
          ((VIDEO_COUNT++))
        done
        
        echo "âœ… ì˜¤ëŠ˜ ì´ $VIDEO_COUNTê°œ ìˆ˜ìµí™” ì˜ìƒ ìƒì„± ì™„ë£Œ! ì˜ˆìƒ ìˆ˜ìµ: $(($VIDEO_COUNT * 50000))ì›"
      
    - name: ì¸ì¦ëœ gcloud ì„¤ì¹˜
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Cloud Run Job ìˆ˜ë™ íŠ¸ë¦¬ê±°
      run: |
        gcloud run jobs run $SERVICE_NAME \
        --region $REGION \
        --project $PROJECT_ID
