name: YouTube Shorts Automation

on:
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 7 * * *'
    - cron: '0 12 * * *'
    - cron: '0 18 * * *'
    - cron: '0 22 * * *'

jobs:
  deploy-and-run-cloud-run-job:
    runs-on: ubuntu-latest

    env:
      REGION: us-central1
      IMAGE_NAME: youtube-automation
      JOB_NAME: youtube-automation-job

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'beta'

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and push Docker image to GCR
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }} .
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}

      - name: Deploy to Google Cloud Run Job
        run: |
          gcloud run jobs deploy ${{ env.JOB_NAME }} \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }} \
            --region ${{ env.REGION }} \
            --service-account=github-actions-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --set-env-vars \
ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }},\
ELEVENLABS_VOICE_ID=${{ secrets.ELEVENLABS_VOICE_ID }},\
PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }},\
YOUTUBE_OAUTH_CREDENTIALS=${{ secrets.YOUTUBE_OAUTH_CREDENTIALS }},\
OPENAI_KEYS_JSON=${{ secrets.OPENAI_KEYS_JSON }},\
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},\
GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},\
GCP_BUCKET_NAME=${{ secrets.GCP_BUCKET_NAME }},\
NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}

      - name: Execute Cloud Run Job
        run: |
          gcloud run jobs execute ${{ env.JOB_NAME }} \
            --region ${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --wait
          echo "‚úÖ Cloud Run Job '${{ env.JOB_NAME }}' Ïã§Ìñâ ÏôÑÎ£å"

      - name: Cleanup artifacts (optional)
        run: |
          rm -rf output/* logs/*
          echo "üßπ Î°úÏª¨ ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨ ÏôÑÎ£å"
