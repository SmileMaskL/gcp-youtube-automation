name: Deploy to GCP

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ”½ğŸ”½ğŸ”½ ì´ ë¶€ë¶„ë§Œ ì •í™•íˆ ìˆ˜ì •í•˜ì„¸ìš”! ğŸ”½ğŸ”½ğŸ”½
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        # âœ… í”„ë¡œì íŠ¸ IDë¥¼ 'youtube-fully-automated'ë¡œ í†µì¼
        workload_identity_provider: 'projects/youtube-fully-automated/locations/global/workloadIdentityPools/github-pool-v2/providers/github-provider'
        service_account: 'github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com'
        token_format: access_token
        access_token_lifetime: 600s
        access_token_scopes: 'https://www.googleapis.com/auth/cloud-platform'
        create_credentials_file: true
        export_environment_variables: true
        universe: googleapis.com

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Build and Push Docker Image
      run: |-
        docker build -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}

    - name: Deploy to Cloud Run
      run: |-
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated

env:
  PROJECT_ID: youtube-fully-automated
  SERVICE_NAME: gcp-youtube-automation
  REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
