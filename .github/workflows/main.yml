name: GCP Youtube Automation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: 'read'
  id-token: 'write'

env:
  JOB_NAME: gcp-youtube-automation-job
  PROJECT_ID: youtube-fully-automated
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/youtube-fully-automated/gcp-youtube-automation
  REGION: us-central1
  GCP_SERVICE_ACCOUNT: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com
  SCHEDULER_JOB_NAME: trigger-youtube-job
  SCHEDULER_TIMEZONE: "Asia/Seoul"

jobs:
  build-and-deploy-infra:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: 📁 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions"
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}
          audience: 'https://token.actions.githubusercontent.com'

      - name: ⚙️ Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: 🐳 Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: 🏗️ Build & Push Docker Image
        run: |
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.JOB_NAME }}:${{ github.sha }} .
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.JOB_NAME }}:${{ github.sha }}

      - name: 👨‍🍳 Deploy Cloud Run Job
        run: |
          gcloud run jobs deploy ${{ env.JOB_NAME }} \
            --image ${{ env.ARTIFACT_REGISTRY }}/${{ env.JOB_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --service-account=${{ env.GCP_SERVICE_ACCOUNT }} \
            --tasks=1 \
            --max-retries=1 \
            --cpu=1 \
            --memory=1Gi \
            --timeout=1800s \
            --update-secrets=PEXELS_API_KEY=PEXELS_API_KEY:latest \
            --update-secrets=YOUTUBE_CLIENT_ID=YOUTUBE_CLIENT_ID:latest \
            --update-secrets=YOUTUBE_CLIENT_SECRET=YOUTUBE_CLIENT_SECRET:latest \
            --update-secrets=YOUTUBE_REFRESH_TOKEN=YOUTUBE_REFRESH_TOKEN:latest \
            --update-secrets=OPENAI_API_KEYS=OPENAI_API_KEYS:latest \
            --update-secrets=GEMINI_API_KEY=GEMINI_API_KEY:latest \
            --update-secrets=ELEVENLABS_API_KEY=ELEVENLABS_API_KEY:latest
            
      - name: ⏰ Create/Update Cloud Scheduler
        run: |
          gcloud scheduler jobs update cloud-run-v2 ${{ env.SCHEDULER_JOB_NAME }} \
            --schedule="${{ env.SCHEDULER_CRON }}" \
            --time-zone="${{ env.SCHEDULER_TIMEZONE }}" \
            --location="${{ env.REGION }}" \
            --job="${{ env.JOB_NAME }}" \
            --description="매일 유튜브 영상 자동 업로드 작업을 실행합니다."
