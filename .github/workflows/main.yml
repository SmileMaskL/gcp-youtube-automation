name: GCP YouTube Automation CI/CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  
env:
  SERVICE_NAME: gcp-youtube-automation
  REGION: us-central1
  PROJECT_ID: youtube-fully-automated
  WORKLOAD_IDENTITY_PROVIDER: projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
  SERVICE_ACCOUNT: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  setup-auth:
    runs-on: ubuntu-latest
    outputs:
      project_id: ${{ env.PROJECT_ID }}
      workload_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
      service_account: ${{ env.SERVICE_ACCOUNT }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Google Cloud ì¸ì¦
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}
        audience: https://token.actions.githubusercontent.com  # âœ… ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ ì¶”ê°€
        access_token_lifetime: 3600s

  deploy:
    runs-on: ubuntu-latest
    needs: setup-auth
    env:
      PROJECT_ID: ${{ needs.setup-auth.outputs.project_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.13'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Docker for GCR ì„¤ì •
      run: gcloud auth configure-docker asia-northeast3-docker.pkg.dev
    
    - name: Secret Managerì—ì„œ ì‹œí¬ë¦¿ ë¡œë“œ
      run: |
        echo "ğŸ” ì‹œí¬ë¦¿ ë¡œë“œ ì‹œì‘"
        
        # í™˜ê²½ ë³€ìˆ˜ ë§¤í•‘ í…Œì´ë¸” (ì‚¬ìš©ì ì‹œí¬ë¦¿ ì´ë¦„ì— ë§ê²Œ ìˆ˜ì •)
        declare -A secret_map=(
          ["OPENAI_API_KEY"]="openai-api-keys"           # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„: openai-api-keys
          ["GEMINI_API_KEY"]="gemini-api-key"             # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„: gemini-api-key
          ["ELEVENLABS_API_KEY"]="elevenlabs-api-key"     # ì‹¤ì œ ì‹œí¬ë¦¿ ì´ë¦„: elevenlabs-api-key
          ["YOUTUBE_CREDENTIALS"]="youtube-oauth-credentials"
          ["STORAGE_BUCKET"]="storage-bucket-name"
        )
        
        for env_var in "${!secret_map[@]}"; do
          secret_name=${secret_map[$env_var]}
          echo "[$env_var] ì‹œí¬ë¦¿ ì ‘ê·¼: $secret_name"
          
          secret_value=$(gcloud secrets versions access latest \
            --secret=$secret_name \
            --project=$PROJECT_ID \
            --format="value(data)")
            
          # ë©€í‹°ë¼ì¸ ì‹œí¬ë¦¿ ì²˜ë¦¬ (JSON í˜•ì‹ì¼ ê²½ìš°)
          if [[ $secret_name == *"credentials"* ]]; then
            echo "$env_var<<EOF" >> $GITHUB_ENV
            echo "$secret_value" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "$env_var=$secret_value" >> $GITHUB_ENV
          fi
          echo "âœ… $env_var ì„¤ì • ì™„ë£Œ"
        done

  generate-content:
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    env:
      PROJECT_ID: ${{ needs.setup-auth.outputs.project_id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Google Cloud ì¸ì¦
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ env.SERVICE_ACCOUNT }}
        audience: https://token.actions.githubusercontent.com  # âœ… ë™ì¼í•˜ê²Œ ì¶”ê°€
    
    - name: Cloud SDK ì„¤ì •
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ìˆ˜ìµí™” ì½˜í…ì¸  ìƒì„± ë° ì—…ë¡œë“œ
      env:
        OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ env.GEMINI_API_KEY }}
        ELEVENLABS_API_KEY: ${{ env.ELEVENLABS_API_KEY }}
        YOUTUBE_CREDENTIALS: ${{ env.YOUTUBE_CREDENTIALS }}
        STORAGE_BUCKET: ${{ env.STORAGE_BUCKET }}
      run: |
        SERVICE_URL=$(gcloud run services describe $SERVICE_NAME \
          --region=$REGION \
          --project=$PROJECT_ID \
          --format='value(status.url)')
        
        # ìˆ˜ìµí™” ê°€ëŠ¥ ì£¼ì œ ë°°ì—´ (ì‹¤ì œ ìˆ˜ìµí™” ê°€ëŠ¥í•œ ì£¼ì œë¡œ êµ¬ì„±)
        MONETIZABLE_TOPICS=(
          "AIë¡œ ìœ íŠœë¸Œ ìë™í™”í•´ì„œ ìˆ˜ìµ ì˜¬ë¦¬ëŠ” ë²•"
          "2025ë…„ ê°€ì¥ ìˆ˜ìµë¥  ë†’ì€ ë¶€ì—… TOP5"
          "ë¬´ë£Œ AI ë„êµ¬ë¡œ ì½˜í…ì¸  ì œì‘í•˜ëŠ” ë²•"
          "ë…¸ì½”ë“œë¡œ ì‹œì‘í•˜ëŠ” ì˜¨ë¼ì¸ ë¹„ì¦ˆë‹ˆìŠ¤"
          "ì±—GPTë¡œ ìœ íŠœë¸Œ ìŠ¤í¬ë¦½íŠ¸ ìë™ ìƒì„±í•˜ê¸°"
          "êµ¬ê¸€ ì• ë“œì„¼ìŠ¤ ìŠ¹ì¸ì„ ìœ„í•œ í•„ìˆ˜ ê°€ì´ë“œ"
          "ìœ íŠœë¸Œ ì•Œê³ ë¦¬ì¦˜ì„ í™œìš©í•œ ì¡°íšŒìˆ˜ í­ì¦ ì „ëµ"
          "íŒŒì´ì¬ ìë™í™”ë¡œ ìˆ˜ìµ ì°½ì¶œí•˜ê¸°"
        )
        
        # ë™ì  ì‹¤í–‰ ê°„ê²© ê³„ì‚° (GCP ë¬´ë£Œ í•œë„ ë‚´ì—ì„œ ìµœëŒ€ íš¨ìœ¨)
        MIN_INTERVAL=300  # 5ë¶„
        MAX_INTERVAL=600  # 10ë¶„
        MIN_DURATION=180  # 3ë¶„
        MAX_DURATION=480  # 8ë¶„
        
        for topic in "${MONETIZABLE_TOPICS[@]}"; do
          echo "ğŸ“¹ ìƒì„± ì‹œì‘: $topic"
          DURATION=$(( MIN_DURATION + RANDOM % (MAX_DURATION - MIN_DURATION + 1) ))
          
          # API í˜¸ì¶œ (íƒ€ì„ì•„ì›ƒ ë° ì¬ì‹œë„ ì„¤ì • í¬í•¨)
          curl -X POST "$SERVICE_URL/generate" \
            -H "Content-Type: application/json" \
            -d "{
              \"topic\": \"$topic\",
              \"style\": \"engaging\",
              \"duration\": $DURATION,
              \"monetization\": true,
              \"call_to_action\": true
            }" \
            --max-time 3600 \
            --retry 2 \
            --retry-delay 30
          
          SLEEP_TIME=$(( MIN_INTERVAL + RANDOM % (MAX_INTERVAL - MIN_INTERVAL + 1) ))
          echo "â± ë‹¤ìŒ ìƒì„±ê¹Œì§€ ëŒ€ê¸°: $((SLEEP_TIME/60))ë¶„"
          sleep $SLEEP_TIME
        done
