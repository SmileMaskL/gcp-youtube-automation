name: Deploy to GCP
env:
  ACTIONS_STEP_DEBUG: true  # üîç ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ÌôúÏÑ±Ìôî
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        service_account: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com
        audience: https://iam.googleapis.com/projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        create_credentials_file: true
        export_environment_variables: true

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --platform=managed \
          --allow-unauthenticated
      env:
        SERVICE_NAME: youtube-automation
        REGION: asia-northeast3
        PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
