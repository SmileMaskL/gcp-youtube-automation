name: Deploy to GCP
env:
  ACTIONS_STEP_DEBUG: true  # 🔍 디버그 로그 활성화
  REGION: us-central1
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        service_account: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com
        audience: https://iam.googleapis.com/projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        create_credentials_file: true
        export_environment_variables: true

    # 2. gcloud 설정
    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    # 3. Docker 이미지 빌드 및 푸시
    - name: Build and Push Container
      run: |
        gcloud auth configure-docker
        docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation .
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation
      env:
        # 필요시 추가 환경 변수 설정
        DOCKER_BUILDKIT: 1  # 빌드킷 활성화

    # 4. Cloud Run 배포 (동일 리전 지정)
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy youtube-automation \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars "PORT=8080" \
          --timeout 600 \
          --cpu 1 \
          --memory 512Mi \
          --min-instances 1 \
          --max-instances 1
           
    - name: Verify Command
      run: |
        echo "실행할 명령어:"
        echo "gcloud run deploy youtube-automation \
        --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation \
        --region us-central1 \
        --platform managed \
        --allow-unauthenticated \
        --set-env-vars PORT=8080 \
        --timeout 600 \
        --cpu 1 \
        --memory 512Mi \
        --min-instances 1 \
        --max-instances 1"
