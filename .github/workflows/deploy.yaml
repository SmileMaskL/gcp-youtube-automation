name: Deploy to GCP
env:
  ACTIONS_STEP_DEBUG: true  # ğŸ” ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”
  REGION: us-central1
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        service_account: github-actions-sa@youtube-fully-automated.iam.gserviceaccount.com
        audience: https://iam.googleapis.com/projects/94662874801/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider-v1
        create_credentials_file: true
        export_environment_variables: true

    # 2. gcloud ì„¤ì •
    - uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and Push Container
      run: |
        gcloud auth configure-docker
        docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation .
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation
      env:
        # í•„ìš”ì‹œ ì¶”ê°€ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        DOCKER_BUILDKIT: 1  # ë¹Œë“œí‚· í™œì„±í™”

    # 4. Cloud Run ë°°í¬ (ë™ì¼ ë¦¬ì „ ì§€ì •)
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy youtube-automation \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/youtube-automation \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
           --set-env-vars "PORT=8080" \  # ëª…ì‹œì  í¬íŠ¸ ì„¤ì •
           --timeout 600s  # íƒ€ì„ì•„ì›ƒ ì—°ì¥(ê¸°ë³¸ê°’: 300s)
           
